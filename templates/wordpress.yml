services:
  db:
    image: mariadb:latest
    container_name: ${COMPOSE_PROJECT_NAME:-wordpress}_db
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_ROOT_HOST: localhost
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_internal
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  wordpress:
    image: wordpress:latest
    container_name: ${COMPOSE_PROJECT_NAME:-wordpress}_app
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    depends_on:
      db:
        condition: service_healthy
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: ${DB_NAME}
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_TABLE_PREFIX: ${WP_TABLE_PREFIX:-wp_}
      WP_DEBUG_MODE: ${WP_DEBUG_MODE:-false}
      WORDPRESS_AUTH_KEY: ${WP_AUTH_KEY}
      WORDPRESS_SECURE_AUTH_KEY: ${WP_SECURE_AUTH_KEY}
      WORDPRESS_LOGGED_IN_KEY: ${WP_LOGGED_IN_KEY}
      WORDPRESS_NONCE_KEY: ${WP_NONCE_KEY}
      WORDPRESS_AUTH_SALT: ${WP_AUTH_SALT}
      WORDPRESS_SECURE_AUTH_SALT: ${WP_SECURE_AUTH_SALT}
      WORDPRESS_LOGGED_IN_SALT: ${WP_LOGGED_IN_SALT}
      WORDPRESS_NONCE_SALT: ${WP_NONCE_SALT}
      WP_HOME: ${WP_HOME}
      WP_SITEURL: ${WP_SITEURL}
      WORDPRESS_CONFIG_EXTRA: |
        /* =================================================================
         * CLOUDFLARE TUNNEL CONFIGURATION
         * ================================================================= */

        /* Real Client IP - Cloudflare puts original IP in CF-Connecting-IP header.
         * Without this, all requests appear to come from cloudflared container. */
        if (isset($$_SERVER['HTTP_CF_CONNECTING_IP'])) {
            $$_SERVER['REMOTE_ADDR'] = $$_SERVER['HTTP_CF_CONNECTING_IP'];
        }

        /* HTTPS Detection - Check both X-Forwarded-Proto and CF-Visitor headers */
        $$is_https = (
            (isset($$_SERVER['HTTP_X_FORWARDED_PROTO']) && $$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') ||
            (isset($$_SERVER['HTTP_CF_VISITOR']) && strpos($$_SERVER['HTTP_CF_VISITOR'], '"scheme":"https"') !== false)
        );
        if ($$is_https) {
            $$_SERVER['HTTPS'] = 'on';
            $$_SERVER['SERVER_PORT'] = 443;
        }

        /* Cloudflare handles HTTPS termination - don't force SSL internally */
        define('FORCE_SSL_ADMIN', false);

        /* Site URLs from environment */
        if (getenv('WP_HOME')) {
            define('WP_HOME', getenv('WP_HOME'));
            define('WP_SITEURL', getenv('WP_SITEURL') ?: getenv('WP_HOME'));
        }

        /* =================================================================
         * SECURITY HARDENING
         * ================================================================= */
        define('DISALLOW_FILE_EDIT', true);
        define('WP_AUTO_UPDATE_CORE', 'minor');

        /* =================================================================
         * PERFORMANCE
         * ================================================================= */
        define('WP_MEMORY_LIMIT', '256M');
        define('WP_MAX_MEMORY_LIMIT', '512M');
        define('WP_POST_REVISIONS', 5);
        define('AUTOSAVE_INTERVAL', 300);
        define('EMPTY_TRASH_DAYS', 14);

        /* =================================================================
         * DEBUG MODE - Set WP_DEBUG_MODE=true in .env to enable
         * ================================================================= */
        $$debug_mode = (getenv('WP_DEBUG_MODE') === 'true');
        define('WP_DEBUG', $$debug_mode);
        define('WP_DEBUG_LOG', $$debug_mode);
        define('WP_DEBUG_DISPLAY', false);

    volumes:
      - wordpress_data:/var/www/html
      # - ./php/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:ro
    networks:
      - wordpress_internal
    # ports:
    #   - "0.0.0.0:${DEBUG_PORT:-8080}:80" # DEBUG 
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f apache2 > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: ${COMPOSE_PROJECT_NAME:-wordpress}_tunnel
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - wordpress_internal
    depends_on:
      db:
        condition: service_healthy
      wordpress:
        condition: service_started

networks:
  wordpress_internal:
    name: ${COMPOSE_PROJECT_NAME:-wordpress}_network
    driver: bridge
    internal: false  # Set to true if you want complete isolation (no internet from containers)

volumes:
  db_data:
    name: ${COMPOSE_PROJECT_NAME:-wordpress}_db_data
  wordpress_data:
    name: ${COMPOSE_PROJECT_NAME:-wordpress}_wp_data